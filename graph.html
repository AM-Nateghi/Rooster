<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نمایشگر گراف چانک‌های کتاب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Glassmorphism styles matching original design */
        .glass {
            background: rgba(255, 255, 255, 0.78);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(15, 23, 42, 0.08);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(15, 23, 42, 0.08);
            transition: all 0.2s ease-in-out;
        }

        .dark .glass-card {
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Light mode background polish (warmer/cream) */
        body:not(.dark) {
            background: linear-gradient(180deg, #fff8ed 0%, #f8efe4 100%);
        }

        body.dark {
            background: #0f172a;
        }

        /* General transitions for a smoother experience */
        * {
            transition: background-color 0.2s, border-color 0.2s, color 0.2s, box-shadow 0.2s;
        }

        /* Node and link styles */
        .node {
            cursor: pointer;
        }

        .node circle {
            stroke: #fff;
            stroke-width: 2px;
            transition: all 0.2s;
        }

        .node:hover circle {
            stroke-width: 4px;
            filter: brightness(1.1);
        }

        .node.selected circle {
            stroke: #ef4444;
            stroke-width: 4px;
        }

        .link {
            stroke-opacity: 0.6;
            transition: all 0.2s;
        }

        .link:hover {
            stroke-opacity: 1;
            stroke-width: 3px !important;
            cursor: pointer;
        }

        .link.selected {
            stroke: #ef4444;
            stroke-opacity: 1;
            stroke-width: 3px !important;
        }

        .node-label {
            font-size: 10px;
            font-weight: 600;
            pointer-events: none;
            text-anchor: middle;
            fill: #334155;
            text-shadow: 0 0 3px white, 0 0 3px white;
        }

        .dark .node-label {
            fill: #e2e8f0;
            text-shadow: 0 0 3px #0f172a, 0 0 3px #0f172a;
        }

        /* Book item hover effect */
        .book-item {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .book-item:hover {
            transform: translateX(-3px);
        }

        /* Scrollbar matching original */
        ::-webkit-scrollbar {
            width: 8px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 2px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.4);
        }

        /* Graph container */
        #graph-container {
            background: rgba(255, 255, 255, 0.3);
        }

        .dark #graph-container {
            background: rgba(15, 23, 42, 0.3);
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-slate-900 min-h-screen font-sans text-slate-800 dark:text-slate-200">

    <!-- Header -->
    <header class="p-4 md:p-6">
        <div class="max-w-full mx-auto">
            <div class="glass rounded-xl p-4 shadow-md">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl md:text-2xl font-bold text-black dark:text-white">
                        🔗 نمایشگر گراف چانک‌های کتاب
                    </h1>
                    <button id="darkToggle"
                        class="glass w-10 h-10 flex items-center justify-center text-lg rounded-full hover:scale-110 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <span class="dark-icon hidden">☀️</span>
                        <span class="light-icon">🌙</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="px-4 md:px-6 pb-6">
        <div class="max-w-full mx-auto flex gap-4" style="height: calc(100vh - 140px);">

            <!-- Sidebar -->
            <aside class="w-72 flex flex-col gap-4 overflow-y-auto">
                <!-- File Upload -->
                <section class="glass rounded-xl p-4 shadow-md">
                    <label for="fileInput"
                        class="flex items-center justify-center gap-2 px-4 py-3 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 active:scale-95 cursor-pointer">
                        <span>📂</span> بارگذاری فایل JSON
                    </label>
                    <input type="file" id="fileInput" accept=".json" class="hidden">
                </section>

                <!-- Stats -->
                <section class="glass rounded-xl p-4 shadow-md">
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div>
                            <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="nodeCount">0</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">نودها</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-green-600 dark:text-green-400" id="linkCount">0</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">یال‌ها</p>
                        </div>
                    </div>
                </section>

                <!-- Toggle Link Mode -->
                <section class="glass rounded-xl p-4 shadow-md">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium">حالت اتصال یال</span>
                        <button id="linkToggle"
                            class="relative w-12 h-6 bg-slate-300 dark:bg-slate-600 rounded-full transition-colors">
                            <span
                                class="absolute top-1 right-1 w-4 h-4 bg-white rounded-full transition-transform duration-200"></span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                        روشن: برای ایجاد یال، دو نود را انتخاب کنید
                    </p>
                </section>

                <!-- Books List -->
                <section class="glass rounded-xl p-4 shadow-md flex-1 overflow-y-auto">
                    <h3 class="text-sm font-bold mb-3 text-slate-700 dark:text-slate-200">📚 کتاب‌ها</h3>
                    <div id="bookList" class="space-y-2"></div>
                </section>
            </aside>

            <!-- Graph Area -->
            <section class="flex-1 flex flex-col gap-4 overflow-hidden">
                <!-- Graph Container -->
                <div id="graph-container" class="glass rounded-xl shadow-md flex-1 relative overflow-hidden">
                    <svg id="graph" class="w-full h-full"></svg>

                    <!-- Empty State -->
                    <div id="emptyState" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <p class="text-6xl mb-4">🔍</p>
                            <p class="text-lg text-gray-500 dark:text-gray-400">هنوز داده‌ای بارگذاری نشده است</p>
                            <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">یک فایل JSON انتخاب کنید</p>
                        </div>
                    </div>
                </div>

                <!-- Detail Panel -->
                <div id="detailPanel" class="glass rounded-xl p-4 shadow-md hidden max-h-64 overflow-y-auto">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200" id="detailTitle">جزئیات</h3>
                        <button id="closeDetail" class="text-red-500 hover:text-red-600 text-xl font-bold leading-none">
                            ✕
                        </button>
                    </div>
                    <div id="detailContent" class="space-y-3 text-sm"></div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // Global state
        let graphData = { nodes: [], links: [] };
        let allData = {};
        let currentBook = null;
        let linkModeEnabled = false;
        let selectedNodeForLink = null;
        let simulation = null;

        // Theme initialization
        function initializeTheme() {
            const isDark = localStorage.getItem("isDark") === "true";
            if (isDark) {
                $("body").addClass("dark");
                $(".dark-icon").removeClass("hidden");
                $(".light-icon").addClass("hidden");
            }
        }

        $("#darkToggle").on("click", function () {
            const body = $("body");
            body.toggleClass("dark");
            const isDark = body.hasClass("dark");
            $(".dark-icon").toggleClass("hidden", !isDark);
            $(".light-icon").toggleClass("hidden", isDark);
            localStorage.setItem("isDark", isDark);
        });

        // Link type configurations
        const linkTypes = {
            reference: { color: '#3b82f6', directed: true, width: 2 },
            'نتیجه‌گیری': { color: '#8b5cf6', directed: true, width: 2.5 },
            'ادامه متن': { color: '#06b6d4', directed: true, width: 2 },
            'مثال': { color: '#10b981', directed: false, width: 2 },
            'بیشتر بدانیم': { color: '#f59e0b', directed: false, width: 2 },
            default: { color: '#64748b', directed: true, width: 1.5 }
        };

        // Node type colors
        const nodeColors = {
            'تعریف': '#3b82f6',
            'مثال': '#10b981',
            'توضیح': '#06b6d4',
            'نتیجه': '#8b5cf6',
            'مرجع': '#f59e0b',
            default: '#64748b'
        };

        // Initialize D3 graph
        const container = document.getElementById('graph-container');
        const svg = d3.select('#graph');

        function getGraphDimensions() {
            const rect = container.getBoundingClientRect();
            return { width: rect.width, height: rect.height };
        }

        const g = svg.append('g');

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Arrow markers for directed edges
        svg.append('defs').selectAll('marker')
            .data(Object.keys(linkTypes))
            .enter().append('marker')
            .attr('id', d => `arrow-${d}`)
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', d => linkTypes[d]?.color || linkTypes.default.color);

        // Load data from file
        $('#fileInput').on('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const data = JSON.parse(event.target.result);
                    processData(data);
                } catch (err) {
                    alert('خطا در خواندن فایل JSON');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        });

        function processData(data) {
            allData = data.entriesByTopic || {};
            renderBookList();

            // Select first book by default
            const firstBook = Object.keys(allData)[0];
            if (firstBook) {
                selectBook(firstBook);
            }

            $('#emptyState').hide();
        }

        function renderBookList() {
            const $bookList = $('#bookList');
            $bookList.empty();

            Object.keys(allData).forEach(book => {
                const count = allData[book].length;
                const $item = $(`
                    <div class="book-item glass-card p-3 rounded-lg cursor-pointer hover:shadow-lg" data-book="${book}">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-sm">${book}</span>
                            <span class="text-xs px-2 py-0.5 rounded-full bg-blue-500 text-white">${count}</span>
                        </div>
                    </div>
                `);
                $bookList.append($item);
            });
        }

        $(document).on('click', '.book-item', function () {
            const book = $(this).data('book');
            selectBook(book);
        });

        function selectBook(book) {
            currentBook = book;

            // Update active state
            $('.book-item').removeClass('ring-2 ring-blue-500');
            $(`.book-item[data-book="${book}"]`).addClass('ring-2 ring-blue-500');

            // Transform data to graph format
            const entries = allData[book] || [];
            graphData.nodes = entries.map(e => ({
                id: e.id,
                title: e.input.slice(0, 50) + (e.input.length > 50 ? '...' : ''),
                fullText: e.input,
                type: e.instruct || 'default',
                order: e.order
            }));

            // Generate demo links based on order proximity
            graphData.links = [];
            for (let i = 0; i < graphData.nodes.length - 1; i++) {
                if (Math.random() > 0.3) {
                    graphData.links.push({
                        source: graphData.nodes[i].id,
                        target: graphData.nodes[i + 1].id,
                        type: 'ادامه متن'
                    });
                }
            }

            // Add some random cross-references
            for (let i = 0; i < graphData.nodes.length; i++) {
                if (Math.random() > 0.7 && i < graphData.nodes.length - 2) {
                    graphData.links.push({
                        source: graphData.nodes[i].id,
                        target: graphData.nodes[i + 2].id,
                        type: Math.random() > 0.5 ? 'reference' : 'مثال'
                    });
                }
            }

            updateStats();
            renderGraph();
        }

        function updateStats() {
            $('#nodeCount').text(graphData.nodes.length);
            $('#linkCount').text(graphData.links.length);
        }

        function renderGraph() {
            g.selectAll('*').remove();
            $('#detailPanel').hide();
            selectedNodeForLink = null;

            if (!graphData.nodes.length) return;

            const { width, height } = getGraphDimensions();

            // Create force simulation
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links)
                    .id(d => d.id)
                    .distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(35));

            // Draw links
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.links)
                .enter().append('line')
                .attr('class', 'link')
                .attr('stroke', d => {
                    const config = linkTypes[d.type] || linkTypes.default;
                    return config.color;
                })
                .attr('stroke-width', d => {
                    const config = linkTypes[d.type] || linkTypes.default;
                    return config.width;
                })
                .attr('marker-end', d => {
                    const config = linkTypes[d.type] || linkTypes.default;
                    return config.directed ? `url(#arrow-${d.type})` : null;
                })
                .on('click', handleLinkClick);

            // Draw nodes
            const node = g.append('g')
                .selectAll('g')
                .data(graphData.nodes)
                .enter().append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded))
                .on('click', handleNodeClick);

            node.append('circle')
                .attr('r', 14)
                .attr('fill', d => nodeColors[d.type] || nodeColors.default);

            node.append('text')
                .attr('class', 'node-label')
                .attr('dy', -20)
                .text(d => d.title.slice(0, 15));

            // Add tooltips
            node.append('title')
                .text(d => d.title);

            // Update positions on tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function handleNodeClick(event, d) {
            event.stopPropagation();

            if (linkModeEnabled && selectedNodeForLink) {
                // Create new link
                if (selectedNodeForLink.id !== d.id) {
                    graphData.links.push({
                        source: selectedNodeForLink.id,
                        target: d.id,
                        type: 'reference'
                    });
                    updateStats();
                    renderGraph();
                }
                selectedNodeForLink = null;
                d3.selectAll('.node').classed('selected', false);
            } else if (linkModeEnabled) {
                // Select node for linking
                selectedNodeForLink = d;
                d3.selectAll('.node').classed('selected', false);
                d3.select(event.currentTarget).classed('selected', true);
            } else {
                // Show detail panel
                showNodeDetail(d);
            }
        }

        function handleLinkClick(event, d) {
            event.stopPropagation();

            if (!linkModeEnabled) {
                showLinkDetail(d);
            }
        }

        function showNodeDetail(node) {
            $('#detailTitle').text('جزئیات نود');
            $('#detailContent').html(`
                <div>
                    <div class="font-semibold text-gray-600 dark:text-gray-400">شناسه:</div>
                    <div class="text-gray-800 dark:text-gray-200">${node.id}</div>
                </div>
                <div>
                    <div class="font-semibold text-gray-600 dark:text-gray-400">نوع:</div>
                    <div class="text-gray-800 dark:text-gray-200">${node.type}</div>
                </div>
                <div>
                    <div class="font-semibold text-gray-600 dark:text-gray-400">ترتیب:</div>
                    <div class="text-gray-800 dark:text-gray-200">#${node.order}</div>
                </div>
                <div>
                    <div class="font-semibold text-gray-600 dark:text-gray-400">متن کامل:</div>
                    <div class="text-gray-800 dark:text-gray-200 leading-relaxed">${node.fullText}</div>
                </div>
            `);
            $('#detailPanel').removeClass('hidden').addClass('block');
        }

        function showLinkDetail(link) {
            const sourceNode = graphData.nodes.find(n => n.id === link.source.id);
            const targetNode = graphData.nodes.find(n => n.id === link.target.id);

            $('#detailTitle').text('جزئیات یال');
            $('#detailContent').html(`
                <div>
                    <div class="font-semibold text-gray-600 dark:text-gray-400">نوع:</div>
                    <div class="text-gray-800 dark:text-gray-200">${link.type}</div>
                </div>
                <div>
                    <div class="font-semibold text-gray-600 dark:text-gray-400">از نود:</div>
                    <div class="text-gray-800 dark:text-gray-200">${sourceNode?.title || 'نامشخص'}</div>
                </div>
                <div>
                    <div class="font-semibold text-gray-600 dark:text-gray-400">به نود:</div>
                    <div class="text-gray-800 dark:text-gray-200">${targetNode?.title || 'نامشخص'}</div>
                </div>
            `);
            $('#detailPanel').removeClass('hidden').addClass('block');
        }

        $('#closeDetail').on('click', function () {
            $('#detailPanel').addClass('hidden').removeClass('block');
        });

        $('#linkToggle').on('click', function () {
            linkModeEnabled = !linkModeEnabled;
            const $toggle = $(this);
            const $dot = $toggle.find('span');

            if (linkModeEnabled) {
                $toggle.removeClass('bg-slate-300 dark:bg-slate-600').addClass('bg-blue-500');
                $dot.addClass('-translate-x-6');
            } else {
                $toggle.removeClass('bg-blue-500').addClass('bg-slate-300 dark:bg-slate-600');
                $dot.removeClass('-translate-x-6');
            }

            selectedNodeForLink = null;
            d3.selectAll('.node').classed('selected', false);
        });

        // Drag functions
        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (simulation && graphData.nodes.length) {
                const { width, height } = getGraphDimensions();
                simulation.force('center', d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            }
        });

        // Initialize
        initializeTheme();
    </script>
</body>

</html>